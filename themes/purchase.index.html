{include file="header.html"}
<script language="javascript" type="text/javascript"> 
$(function(){
	$('#add_time_from').datepicker({dateFormat: 'yy-mm-dd'});
	$('#add_time_to').datepicker({dateFormat: 'yy-mm-dd'});
	
	$("tbody tr").hover(
		function() {
			$(this).css({background:"#EAF8DB"});
		},
		function(){
			$(this).css({background:"#FBFDFF"});
		}
	);
});

function payment(id){
	$('#received_'+id).slideDown('slow');
}
function slideUp_fn(id){
	$('#received_'+id).slideUp('slow');
}

//付款
function sub_payment(o, id){
	var warning = $('#received_'+id+' .warning');
	var obj = $('#money_'+id);
	var money = parseFloat(obj.val());
	var total_price = parseFloat(obj.attr('total_price'));
	var settlement_amount = parseFloat(obj.attr('settlement_amount'));
	
	money = isNaN(money) ? 0 : money;
	total_price = isNaN(total_price) ? 0 : total_price;
	settlement_amount = isNaN(settlement_amount) ? 0 : settlement_amount;
	
	if(money <= 0){
		return;
	}
	
	//已结算金额大于采购金额
	if ((settlement_amount + money) > total_price) {
		if(!confirm('{$lang.settlement_amount_lt}')) {
			return;
		}
	}
	
	$(o).attr('disabled', true);
	obj.attr('disabled', true);
	warning.html('{$lang.submit_warning}');
	$.getJSON("index.php?app=purchase&act=payment", {id: id, money: money}, function(data){
		if (data.done){
			warning.html('{$lang.ok_warning}');
			location.reload();
		}
	});
}

//作废
function subInvalid(id) {
	if(!confirm('{$lang.confirm_is_void}')){
		return false;
    }
	$.getJSON("index.php?app=purchase&act=invalid", {id: id}, function(data){
		if (data.done){
			location.reload();
		}
	});
}

//导出数据
function confirm_submit() {
	if(!confirm('{$lang.confirm_export}')){
		return false;
  }
	var field = $(":input[name='field']").val();
	var search_name = $(":input[name='search_name']").val();
	var add_time_from = $(":input[name='add_time_from']").val();
	var add_time_to = $(":input[name='add_time_to']").val();
	var purchase_type = $(":input[name='purchase_type']").val();
	var status = $(":input[name='status']").val();
	var is_void = $(":input[name='is_void']").val();
	$.get("index.php?app=purchase&act=export_all",{field:field, search_name:search_name, add_time_from:add_time_from, add_time_to:add_time_to, purchase_type:purchase_type, status:status, is_void:is_void});
}
</script>
<div id="rightTop">
    <p>{$lang.purchase_manage}</p>
    <ul class="subnav">
        <li><span>{$lang.manage}</span></li>
        <li><a class="btn1" href="index.php?app=purchase&amp;act=add">{$lang.purchase_manage}</a></li>
        <li><a class="btn4" href="index.php?app=purchase&amp;act=import">{$lang.import_purchase}</a></li>
    </ul>
</div>
<div class="mrightTop">
    <div class="fontl">
        <form method="get">
             <div class="left">
                <input type="hidden" name="app" value="purchase" />
                <select class="querySelect" name="field">
                {html_options options=$search_options selected=$smarty.get.field}
                </select>
                <input class="queryInput" type="text" name="search_name" value="{$query.search_name|escape}" />
                {$lang.add_time_from}:<input class="queryInput pick_date" type="text" value="{$query.add_time_from}" id="add_time_from" name="add_time_from" />
                {$lang.add_time_to}:<input class="queryInput pick_date" type="text" value="{$query.add_time_to}" id="add_time_to" name="add_time_to" />
                {$lang.purchase_type}:
                <select class="querySelect" name="purchase_type">
                <option value="">{$lang.type_all}</option>
                {html_options options=$purchase_type selected=$smarty.get.purchase_type}
                </select>
                {$lang.settlement_status}:
                <select class="querySelect" name="status">
                <option value="">{$lang.type_all}</option>
                {html_options options=$status selected=$smarty.get.status}
                </select>
                {$lang.status_invalid}:
                <select class="querySelect" name="is_void">
                <option value="">{$lang.type_all}</option>
                {html_options options=$status_invalid selected=$smarty.get.is_void}
                </select>
                <input type="submit" class="formbtn" value="{$lang.query}" />
                <input type="submit" class="formbtn" name="export_all" value="{$lang.export}" />
               <!-- onclick="confirm_submit();" />-->
            </div>
            <!--{if $filtered}-->
            <!-- <a class="left formbtn1" href="index.php?app=purchase">{$lang.cancel_query}</a>-->
            <!--{/if}-->
        </form>
    </div>
    <div class="fontr">
        {if $data_list}{include file=page.top.html}{/if}
    </div>
</div>
<div class="tdare">
    <table width="100%" cellspacing="0" class="dataTable">
    	<thead>
        <!--{if $data_list}-->
        <tr class="tatr1">
            <td width="11%" class="firstCell">{$lang.purchase_sn}</td>
            <td width="8%" class="table-center">{$lang.purchase_time}</td>
            <td>{$lang.store_name}</td>
        	<td width="10%">{$lang.store_name_sn}</td>
            <td width="6%" class="table-center">{$lang.purchase_type}</td>
            <td width="6%">{$lang.total_quantity}</td>
            <td width="7%">{$lang.total_price}</td>
            <td width="7%">{$lang.settlement_amount}</td>
            <td width="7%" class="table-center">{$lang.status}</td>
            <td class="table-center">{$lang.status_invalid}</td>
            <td width="4%">{$lang.buyer}</td>
            <td width="12%" class="table-center">{$lang.add_time}</td>
            <td width="8%" class="table-center">{$lang.handler}</td>
        </tr>
        <!--{/if}-->
        </thead>
        <tbody>
        <!--{foreach from=$data_list item=order}-->
        <tr class="tatr2"{if $order.is_void eq '1'} style="color:#F00;"{/if}>
            <td class="firstCell">{$order.purchase_sn|escape}</td>
            <td class="table-center">{$order.purchase_time|escape}</td>
            <td>{$order.store_name|escape}</td>
            <td>{$order.seller_sn|escape|default:-}</td>
            <td class="table-center">{if $order.purchase_type eq 0}{$lang.type_purchase}{elseif $order.purchase_type eq 2}<span style="color:red;">{$lang.type_purchase_returns}</span>{else}{$lang.type_other}{/if}</td>
            <td>{$order.total_quantity}</td>
            <td>{$order.total_price|price:%s}</td>
            <td>{if $order.gt}<span style="color:#090; font-weight:bold;">{$order.settlement_amount|price:%s}</span>{else}{$order.settlement_amount|price:%s}{/if}</td>
            <td class="table-center">{if $order.status eq '1'}{$lang.settled}{elseif $order.status eq '2'}{$lang.notpaid}{elseif $order.status eq '3'}{$lang.hedge}{else}{$lang.unsettled}{/if}</td>
            <td class="table-center">{if $order.is_void eq '1'}{$lang.is_void}{else}{$lang.normal}{/if}</td>
            <td>{$order.buyer|escape|default:-}</td>
            <td class="table-center">{$order.add_time|date:complete}</td>
            <td class="table-center">
              <a href="index.php?app=purchase&amp;act=view&amp;id={$order.purchase_id}">{$lang.view}</a>
              {if $order.invalid eq '1'}
              <a href="javascript:void(0);" onclick="subInvalid({$order.purchase_id});">{$lang.is_void}</a>
              {/if}
              {if ($order.status eq '0' or $order.status eq '2') and $order.is_void eq '0'}
              <a href="javascript:payment({$order.purchase_id});">{$lang.payment}</a>
                <div class="sell_received_money" id="received_{$order.purchase_id}">
                    <a href="javascript:slideUp_fn({$order.purchase_id});" class="close"></a>
                    <p><span>{$lang.payments}:</span><input name="money" id="money_{$order.purchase_id}" type="text" value="" total_price="{$order.total_price}" settlement_amount="{$order.settlement_amount}" />{$lang.yuan}</p>
                    <p><input type="button" class="submit" value="{$lang.submit}" onclick="sub_payment(this,{$order.purchase_id});" /></p>
                    <p class="warning"></p>
                </div>
              {/if}
            </td>
        </tr>
        <!--{foreachelse}-->
        <tr class="no_data">
            <td colspan="13">{$lang.no_data}</td>
        </tr>
        <!--{/foreach}-->
        </tbody>
    </table>
    <!--{if $data_list}-->
    <table width="100%" cellspacing="0" class="dataTable">
    	<thead>
        <tr class="tatr1">
            <td width="70" class="firstCell">{$lang.total_quantity}</td>
            <td width="150">{$lang.total_price}</td>
            <td width="150">{$lang.settlement_amount}</td>
            <td>{$lang.not_settlement_amount}</td>
            <td width="100" class="firstCell">{$lang.total_returns_quantity}</td>
            <td width="150">{$lang.total_returns_price}</td>
            <td width="150">{$lang.settlement_returns_amount}</td>
            <td>{$lang.not_settlement_returns_amount}</td>
        </tr>
        </thead>
        <tbody>
        <tr class="tatr2">
            <td class="firstCell"><span class="total_text">{$total.total_quantity|default:0}</span></td>
            <td><span class="total_text">{$total.total_price|price:%s}</span></td>
            <td><span class="total_text">{$total.settlement_amount|price:%s}</span></td>
            <td><span class="total_text">{$total.not_settlement_amount|price:%s}</span></td>
            <td class="firstCell"><span class="total_text">{$total.total_returns_quantity|default:0}</span></td>
            <td><span class="total_text">{$total.total_returns_price|price:%s}</span></td>
            <td><span class="total_text">{$total.settlement_returns_amount|price:%s}</span></td>
            <td><span class="total_text">{$total.not_settlement_returns_amount|price:%s}</span></td>
        </tr>
        </tbody>
    </table>
    <div id="dataFuncs">
        <div class="pageLinks">
            {include file=page.bottom.html}
        </div>
        
    </div>
    <!--{/if}-->
    <div class="clear"></div>
</div>
{include file="footer.html"}