{include file="header.html"}
<script type="text/javascript" src="{lib file=jquery.plugins/jquery.AddIncSearch-min.js}" charset="utf-8"></script>
<script type="text/javascript">


$(function(){
	$('#refund_time').datepicker({dateFormat: 'yy-mm-dd'});
		
	//退货物品
	$(".checkitem").click(function(){
		if($(this).attr('checked')) {
			$(this).parents('tr').find('td input[class="infoTableInput10"]').attr('disabled',false);
			$('input[name="quantity[]"]').keyup();
		}else {
			$(this).parents('tr').find('td input[class="infoTableInput10"]').attr('disabled',true);			
		}
	});
	
	//备注放大
	$('#buyer_remark').click(function(){var $THIS=$(this);$THIS.animate({width:'300px',height:'200px'});$THIS.keyup(function(){});$THIS.blur(function(){$THIS.animate({width:'160px',height:'18px'})})});
	
	countMoney();
	
	$('#returned_form').validate({
    errorPlacement: function(error, element) {
        $(element).next('.field_notice').hide();
        $(element).after(error)
    },
    success: function(label) {
        label.addClass('right').text('OK!')
    },
    onkeyup: false,
    rules: {
        refund_time: {
            required: true
        },
    },
    messages: {
        refund_time: {
            required: '出仓时间不能为空...'
        },
    }
});
	
	
});

//计算
function countMoney() {
    $('input[name="price[]"], input[name="quantity[]"], input[name="money[]"]').unbind().keyup(function() {
        var obj_p = $(this).parents('tr').find('td input[name="price[]"]');
        var obj_q = $(this).parents('tr').find('td input[name="quantity[]"]');
        var obj_m = $(this).parents('tr').find('td input[name="money[]"]');
        var obj_qOld = $(this).parents('tr').find('td input[name="quantitys[]"]');
        quantitys = parseInt(obj_qOld.val());
        if ($(this).attr('name') == 'quantity[]') {
            var re = /^[1-9]\d*$/;
            if (!re.test($(this).val())) {
                obj_q.val(quantitys);
                $('input[name="price[]"], input[name="quantity[]"], input[name="money[]"]').keyup()
            }
        }
        var price = isNaN(parseFloat(obj_p.val())) ? 0 : parseFloat(obj_p.val());
        var quantity = isNaN(parseInt(obj_q.val())) ? 0 : parseInt(obj_q.val());
        var money = isNaN(parseFloat(obj_m.val())) ? 0 : parseFloat(obj_m.val());
        if ($(this).attr('name') == 'money[]') {
            if (quantity > quantitys) {
                obj_q.val(quantitys);
                $('input[name="price[]"], input[name="quantity[]"], input[name="money[]"]').keyup();
                return
            } else if (quantity > 0) {
                price = Math.round(money / quantity * 100) / 100;
                obj_p.val(price)
            } else {
                obj_p.val(0)
            }
        } else {
            if (quantity > quantitys) {
                obj_q.val(quantitys);
                $('input[name="price[]"], input[name="quantity[]"], input[name="money[]"]').keyup();
                return
            }
            obj_m.val(Math.round(price * quantity * 100) / 100)
        }
    })
}





//提交
function confirm_submit() {
	var url="index.php?app=warehouse&act=is_stock";	
	var num = $('input[name="quantity[]"]:not(:disabled)').size();	
	var s = 0,msg='';	
	$('input[name="quantity[]"]:not(:disabled)').each(function(i){		
		var $THIS = $(this);
		var sell_obj = $(this).parents('tr').find('td input[name="goods_sn[]"]');		//销售数量对象
		var sell_id = sell_obj.val();
		var quantity = parseInt($(this).val());				
		$.getJSON(url + "&sid=" + sell_id + '&quantity=' + quantity,
		function(retdata) {
			if (retdata.done) {
				$THIS.css('border-color', ''); ++s
			} else {
				msg = msg + '\n' + retdata.msg;
				$THIS.css('border-color', 'red')
			}
			if (num == i + 1) {
				if(msg)
				alert(msg);
				if (s == num) {
					if (!confirm('{$lang.confirm_submit}')) {
						return false
					}
					$('#returned_form').submit()
				}
			}
		});	
	});
	
	
	
}
</script>
<div id="rightTop">
  <p>{$lang.returned_manage}</p>
  <ul class="subnav">
    <li><a class="btn1" href="index.php?app=returned">{$lang.returned_list}</a></li>
  </ul>
</div>
<form method="post" enctype="multipart/form-data" name="returned_form" id="returned_form">
<input type="hidden" name="app" value="{$smarty.get.app}" />
<input type="hidden" name="act" value="{$smarty.get.act}" />
<input type="hidden" name="total_money" value="{$sell_info.total_money}" />
<div class="tdare">
    <table width="100%" cellspacing="0" class="dataTable">
    	<thead>
        <tr class="tatr1" style="background-color:#B9FFFF;">
        	<td class="firstCell">{$lang.sell_sn}</td>
            <td>{$lang.returned_time}</td>
            <td>{$lang.returned_type}</td>
        	<td>{$lang.order_sn}</td>
            <td>{$lang.buyer_name}</td>
            <td>{$lang.payment}</td>
            <td>{$lang.shipping_name}</td>
            <td>{$lang.shipping_sn}</td>
            <td>{$lang.shipping_fee}</td>
            <td>{$lang.buyer_remark}</td>
        </tr>
        </thead>
        <tbody>
        <tr class="tatr2" style="background-color:#E1FFF0;">
            <td class="firstCell"><input name="sell_sn" type="text" class="infoTableInput4" id="sell_sn" value="{$sell_info.sell_sn|escape}" readonly="readonly" /></td>
            <td><input class="infoTableInput3 pick_date" id="refund_time" type="text" name="refund_time" value="{$refund.refund_time|escape}" readonly="readonly" /></td>
            <td>
                <select class="querySelect" name="returned_type" id="returned_type" style="width:62px;">
                	{html_options options=$returned_type selected=$sell_info.order_type}
                </select>
            </td>
            <td><input name="order_sn" type="text" class="infoTableInput3" id="order_sn" value="{$sell_info.order_sn}" readonly="readonly" /></td>
            <td>
                <select class="infoTableInput4 querySelect" name="buyer_id" id="buyer_id" >
                	{html_options options=$buyers selected=$sell_info.buyer_id}
                </select>
            </td>
            <td><input name="payment" type="text" disabled="disabled" class="infoTableInput3" id="payment" value="{$sell_info.payment}"  /></td>
            <td><input name="shipping_name" type="text" class="infoTableInput3" id="shipping_name" value="{$sell_info.shipping_name}" /></td>
            <td><input class="infoTableInput3" id="shipping_sn" type="text" name="shipping_sn" value="{$sell_info.shipping_sn}" /></td>
            <td><input class="infoTableInput3" id="shipping_fee" type="text" name="shipping_fee" value="{$sell_info.shipping_fee}" /></td>
            <td style="width:280px;position:relative;top:10px;">          
            
            <textarea name="buyer_remark" class="infoTableInput3" id="buyer_remark" style="position:absolute;left:0px;top:0px;"></textarea>
            <input class="infoTableInput3" id="buyer_remark_old" type="hidden" name="buyer_remark_old" value="{$sell_info.buyer_remark}" />
            
            </td>
        </tr>
        <tr class="tatr2" style="background-color:#E1FFF0;">
            <td colspan="10" class="firstCell">{$lang.remark}{$sell_info.buyer_remark}</td>
          </tr>
          
          
          <tr class="tatr2" style="background-color:#E1FFF0;">
          <td class="firstCell">收件人姓名：</td>
          <td>{$client_p.name}</td>
          <td>&nbsp;</td>
          <td colspan="2">收件人电话：{$client_p.phone}</td>
          <td colspan="5">收件人地址:{$client_p.address}</td>
        </tr>
          
        </tbody>
    </table>

    <table width="100%" cellspacing="0" class="dataTable">
    	<thead>
        <tr class="tatr1" style="background-color: #BDF;">
            <td width="5%" class="firstCell"></td>
            <td>{$lang.goods_sn}</td>
            <td>{$lang.goods_name}</td>
            <td>{$lang.brand_name}</td>
        	<td>{$lang.store_goods_code}</td>
            <td>{$lang.goods_colour}</td>
            <td class="table-center">{$lang.unit}</td>
            <td>{$lang.goods_specification}</td>
            <td>{$lang.price}</td>
            <td>{$lang.price_cost}
          </td>
            <td>{$lang.quantity}</td>
            <td>{$lang.returned_quantity}</td>
           
            <td>{$lang.returned_money}</td>
            
          <td>{$lang.remark}</td>
        </tr>
        </thead>
        <tbody>
        <!--{foreach from=$data.sd item=goods key=key}-->
        <tr class="tatr2" style="background-color:#E1FFF0;">
        	<td class="firstCell"><input type="checkbox" class="checkitem" name="sell_detailed_id[]" value="{$key}" /></td>
            <td><input class="infoTableInput10" type="text" name="goods_sn[]" disabled="disabled" value="{$goods.goods_sn|escape|default:-}" style="width:85px;" readonly="readonly" /></td>
            <td><input class="infoTableInput10" type="text" name="goods_name[]" disabled="disabled" value="{$goods.goods_name|escape|default:-}" style="width:185px;" readonly="readonly" /></td>
            <td><input class="infoTableInput10" type="text" name="brand_name[]" disabled="disabled" value="{$goods.brand_name|escape|default:-}" readonly="readonly" /></td>
            <td><input class="infoTableInput10" type="text" name="store_goods_code[]" disabled="disabled" value="{$goods.store_goods_code|escape|default:-}" readonly="readonly" /></td>
            <td><input class="infoTableInput10" type="text" name="goods_colour[]" disabled="disabled" value="{$goods.goods_colour|escape|default:-}" style="width:45px;" readonly="readonly" /></td>
            <td class="table-center"><input class="infoTableInput10" type="text" name="unit[]" disabled="disabled" value="{$goods.unit|escape|default:-}" style="width:30px;" readonly="readonly" /></td>
            <td><input class="infoTableInput10" type="text" name="goods_specification[]" disabled="disabled" value="{$goods.goods_specification|escape|default:-}" style="width:50px;" readonly="readonly" /></td>
            <td>{$goods.price|price:%s}</td>
            <td>{$goods.price_cost|price:%s}
            <input class="infoTableInput10" type="hidden" name="price[]" value="{$goods.price_cost|price:%s}" style="width:50px;" disabled="disabled" />
            </td>
            <td>{$goods.quantity|escape|default:-}</td>
            <td>
            
            <input class="infoTableInput10" type="hidden" name="quantitys[]" value="{$goods.quantity|escape|default:-}" />
            <input class="infoTableInput10" type="text" name="quantity[]" value="{$goods.quantity|escape|default:-}" style="width:45px;" disabled="disabled" /></td>
          
            <td><input class="infoTableInput10" type="text" name="money[]" disabled="disabled" value="" style="width:60px;" readonly="readonly" /></td>
            
          <td><input class="infoTableInput10" type="text" name="remark[]" disabled="disabled" value="" style="width:50px;" /></td>
        </tr>
        <!--{/foreach}-->
        </tbody>
    </table>
    
    <div id="dataFuncs">
    	<div class="printLinks">
        </div>
        <div class="submit-center">
        	<input class="formbtn" type="button" name="Submit" value="{$lang.submit}" onclick="confirm_submit();" />
            <input class="formbtn" type="reset" name="Reset" value="{$lang.reset}" />
        </div>
    </div>
    <div class="clear"></div>
</div>
</form>
{include file="footer.html"}